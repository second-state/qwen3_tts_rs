name: Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: Linux x86_64 CPU
            backend: tch
            suffix: linux-x86_64-cpu
            libtorch-url: https://download.pytorch.org/libtorch/cpu/libtorch-cxx11-abi-shared-with-deps-2.10.0%2Bcpu.zip
            libtorch-archive: libtorch.zip
          - os: ubuntu-latest
            name: Linux x86_64 CUDA
            backend: tch
            suffix: linux-x86_64-cuda
            libtorch-url: https://download.pytorch.org/libtorch/cu128/libtorch-cxx11-abi-shared-with-deps-2.10.0%2Bcu128.zip
            libtorch-archive: libtorch.zip
          - os: ubuntu-24.04-arm
            name: Linux ARM64 CPU
            backend: tch-pip
            suffix: linux-aarch64-cpu
          - os: macos-latest
            name: macOS ARM64 (MLX)
            backend: mlx
            suffix: macos-arm64

    runs-on: ${{ matrix.os }}
    name: Build (${{ matrix.name }})

    steps:
      - uses: actions/checkout@v4

      - name: Init MLX submodule
        if: matrix.backend == 'mlx'
        run: git submodule update --init --recursive

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Download libtorch
        if: matrix.backend == 'tch'
        run: curl -Lo ${{ matrix.libtorch-archive }} "${{ matrix.libtorch-url }}"

      - name: Extract libtorch
        if: matrix.backend == 'tch'
        run: |
          if [[ "${{ matrix.libtorch-archive }}" == *.zip ]]; then
            unzip -q ${{ matrix.libtorch-archive }}
          else
            tar xzf ${{ matrix.libtorch-archive }}
          fi

      - name: Set up Python (ARM64)
        if: matrix.backend == 'tch-pip'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install PyTorch via pip (ARM64)
        if: matrix.backend == 'tch-pip'
        run: pip install torch==2.10.0

      - name: Build (tch)
        if: matrix.backend == 'tch'
        env:
          LIBTORCH: ${{ github.workspace }}/libtorch
        run: cargo build --release

      - name: Build (tch-pip)
        if: matrix.backend == 'tch-pip'
        env:
          LIBTORCH_USE_PYTORCH: "1"
        run: cargo build --release

      - name: Build (MLX)
        if: matrix.backend == 'mlx'
        run: cargo build --release --no-default-features --features mlx

      - name: Locate libtorch from pip (ARM64)
        if: matrix.backend == 'tch-pip'
        run: |
          TORCH_LIB=$(python3 -c "import torch; print(torch.__path__[0])")
          cp -r "$TORCH_LIB/lib" libtorch_lib
          echo "LIBTORCH_LIB=libtorch_lib" >> "$GITHUB_ENV"

      - name: Package release (tch)
        if: matrix.backend == 'tch'
        run: |
          DIST="qwen3-tts-${{ matrix.suffix }}"
          mkdir -p "$DIST"
          cp target/release/tts target/release/voice_clone "$DIST/"
          cp -r libtorch "$DIST/"
          tar czf "$DIST.tar.gz" "$DIST"

      - name: Package release (tch-pip)
        if: matrix.backend == 'tch-pip'
        run: |
          DIST="qwen3-tts-${{ matrix.suffix }}"
          mkdir -p "$DIST/libtorch/lib"
          cp target/release/tts target/release/voice_clone "$DIST/"
          cp -r libtorch_lib/* "$DIST/libtorch/lib/"
          tar czf "$DIST.tar.gz" "$DIST"

      - name: Package release (MLX)
        if: matrix.backend == 'mlx'
        run: |
          DIST="qwen3-tts-${{ matrix.suffix }}"
          mkdir -p "$DIST"
          cp target/release/tts target/release/voice_clone "$DIST/"
          tar czf "$DIST.tar.gz" "$DIST"

      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: qwen3-tts-${{ matrix.suffix }}.tar.gz
